name: CI/CD Pipeline
on:
  workflow_dispatch:
  push:

jobs:
  test:
    name: Kjør tester
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install npm dependencies
        run: npm ci
        env:
          NPM_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Kjør tester
        run: npm test -- --run

  lint:
    name: Lint og formatering
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install npm dependencies
        run: npm ci
        env:
          NPM_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Sjekk formatering
        run: npm run prettier:check
      - name: Lint kode
        run: npm run lint

  build:
    name: Valider byggbarhet
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install npm dependencies
        run: npm ci
        env:
          NPM_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Valider TypeScript kompilering
        run: npx tsc --noEmit

      - name: Test ncc bundling på ett vilkårlig script
        run: npm run build-prodansvar

      - name: Valider at genererte filer kan leses
        run: |
          echo "Sjekker at prod-ansvarlig.json er gyldig etter bygg..."
          node -e "
            const fs = require('fs');
            const file = 'ukeoversikt/prod-ansvarlig.json';
            if (fs.existsSync(file)) {
              JSON.parse(fs.readFileSync(file, 'utf8'));
              console.log(\`✅ \${file} er gyldig JSON og ble generert av bygget\`);
            } else {
              console.error(\`❌ \${file} ble ikke generert av bygget\`);
              process.exit(1);
            }
          "
